# LoopSpot â€” Deep Links, Guest Flow, Modals & Auth

## Background
Originally, the app had a **single Home screen (`app/home.jsx`)** that both creators and guests used.  

- **Creators (loop owners)** needed to:
  - Create loops
  - Share links with friends
- **Guests (end users)** needed to:
  - Accept an invite
  - See loop details
  - Possibly add a location

### Problem
The **same home screen** was trying to serve both roles. Guests ended up seeing creator features (like â€œCreate Loopâ€) that werenâ€™t relevant to them. This created confusion.

---

## Goal
1. **Split the UX for creators and guests** so each sees only what they need.
2. **Enable deep links without a backend**, so guests can open an invite link and immediately see loop details.
3. **Introduce reusable modals** for creating and viewing loops.
4. Keep codebase **organized and scalable**.
5. Extend the **guest experience** to allow multi-pin workflows (with names & times), editing, and clearing locations.
6. **Add authentication** (Firebase email/password) with login & signup.
7. Show the userâ€™s **display name** (or email prefix) in the Home greeting.

---

## Final Flow

### Creator
- Signs in via **login/signup screen** (`app/index.jsx`).
- Starts in `/home.jsx`.
- Sees greeting: `Hi {displayName},`.
- Uses `CreateLoopModal` to create a loop.
- Loop is saved locally in `AsyncStorage`. 
- A deep link is generated:  
  `exp://<dev-server>/--/loop/<loopId>?d=<urlencoded JSON>`
- Creator shares the link.

### Guest
- Opens the deep link on their device.
- Lands on `/loop/[loopId].jsx` (Accept/Reject screen).
- Loop data is resolved from:
  - `AsyncStorage.getItem(loopId)`, or
  - the payload in the `?d=` query.
- On **Accept**, guest is redirected to `/guest-home.jsx`:
  ```js
  router.replace({
    pathname: '/guest-home',
    params: { loopId: String(loopId), d: d ? String(d) : '' },
  });


app/
  index.jsx                # login/signup screen (Firebase)
  home.jsx                 # creator home (map + greeting + create loop modal)
  guest-home.jsx           # guest home (map + auto-open details modal + pins flow)
  loop/
    [loopId].jsx           # accept/reject invite screen
    utils/
      linkUtils.js         # getShareLink(), generateLoopId()
  components/
    CreateLoopModal.jsx    # modal for creating/sharing loops
    LoopDetailsModal.jsx   # modal for viewing loop details
  services/
    authService.js         # Firebase authentication service

### ğŸ§  Why This Structure?

- `app/` contains **navigable screens** (routes).
- `app/components/` contains **reusable UI components**, not routes.
- Initially, `CreateLoopModal` was incorrectly placed in `app/`, causing import issues. âœ… Fixed by moving it to `app/components/`.

---

## ğŸ”‘ Key Concepts

### ğŸš Expo Router

File-based navigation:

| File Path               | Route           |
| ----------------------- | --------------- |
| `app/home.jsx`          | `/home`         |
| `app/guest-home.jsx`    | `/guest-home`   |
| `app/loop/[loopId].jsx` | `/loop/:loopId` |

Works seamlessly with Expo deep links:  
`exp://â€¦/--/path`

---

### ğŸ”— Deep Linking

- Use `Linking.createURL('/loop/<id>')` to generate links.
- Append `?d=<urlencoded JSON>` to embed loop details (no backend required).
- Guests decode this payload locally.

---

### ğŸ’¾ AsyncStorage

Local keyâ€“value storage (similar to `localStorage` in React Native).

Used to:
- Save created loops under `loopId`.
- Retrieve loop data when a guest accepts.

Potential future use:
- Store `userRole` (creator / guest) for auto-routing.

---

### Firebase Authentication
- Implemented in app/services/authService.js.
Provides:
- signUp(name, email, password)
- signIn(email, password)
- signOut()
- getCurrentUser()
- onAuthStateChanged(cb)
app/index.jsx is the login/signup UI:
- Toggle between Sign In and Sign Up.
- On signup, Firebase auto-creates the user and saves displayName.
app/home.jsx:
- Subscribes to auth state.
- Shows Hi {displayName} card.

## ğŸ›  Step-by-Step Implementation

### 1. Accept/Reject Screen (`app/loop/[loopId].jsx`)

- Handles invite links.
- Loads loop data from AsyncStorage or `?d` payload.
- Displays loop info and Accept / Reject buttons.
- On Accept â†’ redirects to `/guest-home`.

---

### 2. Guest Home (`app/guest-home.jsx`)

Guest landing screen after accepting an invite.

#### ğŸ—º Map Features:
- Current location
- Saved pins

#### ğŸ”„ On Mount:
- Resolves loop data (AsyncStorage â†’ payload).
- Auto-opens `LoopDetailsModal`.

#### â• Multi-Pin Add Flow:
1. Guest enters number of pins in `LoopDetailsModal` (e.g., 2).
2. Enters add-mode:
   - Remaining count displayed.
   - Guest long-presses map to drop a pending pin.
   - A card pops up to enter Name and Time to stay.
3. On Add:
   - Pin is persisted.
   - Count decrements.
4. When all pins are placed:
   - Add-mode ends silently.
   - Pins remain visible on map.

#### âœï¸ Editing Pins:
- Tap an existing pin â†’ opens Edit card.
- Update Name and Time â†’ Save.
- Changes persisted to AsyncStorage.

#### ğŸ§¹ Clearing Pins:
- Floating red â€œRemove all pinsâ€ button clears all pins from the loop.

---

### 3. LoopDetailsModal (`app/components/LoopDetailsModal.jsx`)

Reusable modal for loop details.

- Input for Add Location Number.
- â€œAdd Locationâ€ button passes count back to `guest-home` to trigger add-mode.
- Can be extended for both creators & guests.

---

### 4. CreateLoopModal (`app/components/CreateLoopModal.jsx`)

Modal for creators to:
- Create a new loop
- Generate deep links

âœ… Correctly located under `app/components/`.

---
### 5. Home Greeting (with Auth)

home.jsx now greets the logged-in user:
- Hi {displayName},
- Fallbacks: displayName â†’ else email prefix â†’ else "User".

## ğŸ¬ Demo Flow (Guest)

1. Guest opens invite link.
2. Accepts invite â†’ lands on `/guest-home`.
3. `LoopDetailsModal` opens:
   - Enters `2` â†’ taps â€œAdd Locationâ€.
4. On map:
   - Long-press â†’ enters *Hall*, 30 min â†’ taps Add.
   - Long-press again â†’ enters *Cafe*, 45 min â†’ taps Add.
5. Done! Two pins appear on map with details.
6. Later:
   - Taps a pin â†’ edits name/time.
   - Or clears all pins via the â€œRemove all pinsâ€ button.

### ğŸ¬ Demo Flow (Auth + Creator)
- User launches app â†’ sees login/signup screen.
- Taps â€œDonâ€™t have an account? Sign Upâ€:
- Enters full name, email, password â†’ Firebase creates account.
- Lands on /home:
- Greeting card: Hi John,
- Can create loop via modal.

- 31-08-2025: Added Firebase Authentication (authService.js, index.jsx login/signup), updated home.jsx greeting with displayName.